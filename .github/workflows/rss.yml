name: Generate Telegram RSS

on:
  schedule:
    # 08, 11, 14, 17, 20 МСК (UTC+3 → 05, 08, 11, 14, 17 UTC)
    # - cron: "0 5,8,11,14,17 * * *"
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Start RSS-Bridge container
        run: |
          docker run -d --name rss-bridge -p 8080:80 rssbridge/rss-bridge
          sleep 15

      - name: Generate feeds from Telegram channels
        run: |
          mkdir -p out
          # очищаем лог ошибок на этот запуск
          : > out/_errors.log

          while read CHANNEL; do
          
            # пропускаем пустые строки и комментарии
            [[ -z "$CHANNEL" || "$CHANNEL" =~ ^# ]] && continue

            SAFE_NAME=$(echo "$CHANNEL" | tr -d '@')
            URL="http://localhost:8080/?action=display&bridge=Telegram&format=Atom&username=${CHANNEL}"

            echo "Fetching ${CHANNEL} -> out/${SAFE_NAME}.xml"

            success=false

            for attempt in 1 2; do
              if curl -fsS \
                   -A "Mozilla/5.0 (compatible; TelegramRSSBot/1.0; +https://github.com/justSmK/telegram-rss)" \
                   "$URL" \
                   -o "out/${SAFE_NAME}.xml"; then
                echo "OK: ${CHANNEL} (attempt ${attempt})"
                success=true
                break
              else
                echo "FAIL: ${CHANNEL} (attempt ${attempt})" | tee -a out/_errors.log
                # небольшая пауза перед повтором
                sleep $((5 * attempt))
              fi
            done

            if [ "$success" = false ]; then
              echo "GIVE UP: ${CHANNEL} after 2 attempts" | tee -a out/_errors.log
            fi

            # лёгкий rate limit между каналами
            sleep 1
          done < channels.txt

      - name: Copy index.html and channels.txt
        run: |
          mkdir -p out
          cp index.html out/index.html
          cp style.css out/style.css
          cp channels.txt out/channels.txt

      - name: Deploy to GitHub Pages (gh-pages branch)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          publish_branch: gh-pages
