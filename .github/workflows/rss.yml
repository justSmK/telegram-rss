name: Generate Telegram RSS

on:
  schedule:
    # 08, 11, 14, 17, 20 МСК (UTC+3 → 05, 08, 11, 14, 17 UTC)
    - cron: "0 5,8,11,14,17 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Start RSS-Bridge container
        run: |
          docker run -d --name rss-bridge -p 8080:80 rssbridge/rss-bridge
          sleep 15

      - name: Generate feeds from Telegram channels
        run: |
          mkdir -p out
          : > out/_errors.log

          while read CHANNEL; do
            [[ -z "$CHANNEL" || "$CHANNEL" =~ ^# ]] && continue

            SAFE_NAME=$(echo "$CHANNEL" | tr -d '@')
            URL="http://localhost:8080/?action=display&bridge=Telegram&format=Atom&username=${CHANNEL}"

            echo "Fetching ${CHANNEL} -> out/${SAFE_NAME}.xml"

            success=false

            for attempt in 1 2; do
              if curl -fsS "$URL" -o "out/${SAFE_NAME}.xml"; then
                echo "OK: ${CHANNEL} (attempt ${attempt})"
                success=true
                break
              else
                echo "FAIL: ${CHANNEL} (attempt ${attempt})" | tee -a out/_errors.log
                sleep 10
              fi
            done

            if [ "$success" = false ]; then
              echo "GIVE UP: ${CHANNEL} after 2 attempts" | tee -a out/_errors.log
            fi

          done < channels.txt

      - name: Deploy to GitHub Pages (gh-pages branch)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          publish_branch: gh-pages
