name: Generate Telegram RSS

on:
  schedule:
    # 08, 11, 14, 17, 20 МСК (UTC+3 → 05, 08, 11, 14, 17 UTC)
    # - cron: "0 5,8,11,14,17 * * *"
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: telegram-rss
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Start RSS-Bridge container
        run: |
          docker rm -f rss-bridge || true
          docker run -d --name rss-bridge -p 8080:80 \
            -v "${GITHUB_WORKSPACE}/config:/config" \
            rssbridge/rss-bridge

          READY=false
          for i in {1..20}; do
            if curl -sf http://localhost:8080/ > /dev/null; then
              READY=true
              echo "RSS-Bridge is ready"
              break
            fi
            echo "Waiting for RSS-Bridge... (${i}/20)"
            sleep 1
          done

          if [ "$READY" != "true" ]; then
            echo "RSS-Bridge failed to start"
            docker ps -a
            docker logs rss-bridge || true
            exit 1
          fi

          docker exec rss-bridge ls -la /config

      - name: Generate feeds from Telegram channels
        run: |
          mkdir -p out
          # очищаем лог ошибок на этот запуск
          : > out/_errors.log

          while read CHANNEL; do
          
            # пропускаем пустые строки и комментарии
            [[ -z "$CHANNEL" || "$CHANNEL" =~ ^# ]] && continue

            SAFE_NAME=$(echo "$CHANNEL" | tr -d '@')
            URL="http://localhost:8080/?action=display&bridge=Telegram&format=Atom&username=${CHANNEL}"
            TMP_FILE="out/${SAFE_NAME}.xml.tmp"

            echo "Fetching ${CHANNEL} -> out/${SAFE_NAME}.xml"

            success=false

            for attempt in 1 2; do
              if curl -fsS \
                   --max-time 30 \
                   -A "Mozilla/5.0 (compatible; TelegramRSSBot/1.0; +https://github.com/justSmK/telegram-rss)" \
                   "$URL" \
                   -o "$TMP_FILE"; then
                if [ -s "$TMP_FILE" ] \
                  && grep -Eq '<\?xml|<feed\b|<rss\b' "$TMP_FILE" \
                  && ! grep -Eq 'Bridge returned error|cURL error' "$TMP_FILE"; then
                  mv "$TMP_FILE" "out/${SAFE_NAME}.xml"
                  echo "OK: ${CHANNEL} (attempt ${attempt})"
                  success=true
                  break
                else
                  echo "INVALID: ${CHANNEL} (attempt ${attempt})" | tee -a out/_errors.log
                  rm -f "$TMP_FILE"
                fi
              else
                echo "FAIL: ${CHANNEL} (attempt ${attempt})" | tee -a out/_errors.log
                rm -f "$TMP_FILE"
                # небольшая пауза перед повтором
                sleep $((5 * attempt))
              fi
            done

            if [ "$success" = false ]; then
              echo "GIVE UP: ${CHANNEL} after 2 attempts" | tee -a out/_errors.log
            fi

            # лёгкий rate limit между каналами
            sleep 1
          done < channels.txt

      - name: Copy index.html and channels.txt
        run: |
          mkdir -p out
          cp index.html out/index.html
          cp style.css out/style.css
          cp channels.txt out/channels.txt

      - name: Deploy to GitHub Pages (gh-pages branch)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          publish_branch: gh-pages
